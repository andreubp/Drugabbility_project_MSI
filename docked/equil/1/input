
set numsteps 1000
set temperature 298
set refindex {  }
set selindex {  }
set box { 0 0 0 0 0 0 }
set K 0
#
proc flatbot1d {x xm xM K} {
  set f 0
  if {$x < $xm} {
    set f [expr $K*[expr $xm-$x]]
  }
  if {$x > $xM} {
    set f [expr $K*[expr $xM-$x]]
  }
  return $f
}
proc calcforces_init {} {
  global ref sel refindex selindex
  berendsenpressure  off
  set ref [addgroup  $refindex]
  set sel [addgroup  $selindex]
}
proc calcforces {} {
  global ref sel numsteps K box
  loadcoords coords
##FLATBOTTOM
  if {$K>0} {
    set r0 $coords($ref)
    set r1 $coords($sel)
    set dr  [vecsub $r1 $r0]
    set fx [flatbot1d [lindex $dr 0] [lindex $box 0] [lindex $box 1] $K]
    set fy [flatbot1d [lindex $dr 1] [lindex $box 2] [lindex $box 3] $K]
    set fz [flatbot1d [lindex $dr 2] [lindex $box 4] [lindex $box 5] $K]
    #print "dr: $dr  fx: $fx fy: $fy fz: $fz"
    addforce $sel [list $fx $fy $fz]
  }
##EQUIL
  set step [ getstep ]
  if { $step > 500 } {
    berendsenpressure  on
  } else {
    berendsenpressure  off}
  if { $step > [expr $numsteps/2] } {
    constraintscaling 0
  } else {
    constraintscaling [expr 1 + $step*(0.05-1)*2/$numsteps]}
}
proc calcforces_endstep { } { }
#
berendsenpressure              	on
berendsenpressurerelaxationtime	800
berendsenpressuretarget        	1.01325
celldimension                  	86.29199981689453 86.29000091552734 86.29000091552734
consref                        	structure.pdb
constraints                    	on
constraintscaling              	1.0
coordinates                    	structure.pdb
cutoff                         	9
energyfreq                     	1000
exclude                        	scaled1-4
fullelectfrequency             	2
hydrogenscale                  	4
langevin                       	on
langevindamping                	1
langevintemp                   	$temperature
minimize                       	500
outputname                     	output
parameters                     	parameters
pme                            	on
pmegridspacing                 	1.0
restart                        	on
restartfreq                    	5000
rigidbonds                     	all
1-4scaling                     	1.0
structure                      	structure.psf
switchdist                     	7.5
switching                      	on
tclforces                      	on
temperature                    	$temperature
timestep                       	4
xtcfile                        	output.xtc
xtcfreq                        	25000
run                            	$numsteps
